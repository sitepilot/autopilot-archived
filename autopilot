#!/bin/bash
BASE=`dirname $0`

if [ -t 1 ]; then
    IT='-it'
else
    IT=''
fi

case "$1" in
'install'|'install-test')  echo "Installing Autopilot"
    if [ "$1" == 'install-test' ]; then
        docker-compose -f $BASE/docker-compose.test.yml --env-file $BASE/.env up -d
    else
        mkdir -p $BASE/data/app
        mkdir -p $BASE/data/mysql
        mkdir -p $BASE/data/vendor
        docker-compose -f $BASE/docker-compose.yml --env-file $BASE/.env up -d
    fi

    echo "Waiting for containers..."
    sleep 10

    if [ ! -z "$2" ]; then
        docker exec $IT -w /var/www/html autopilot composer config http-basic.nova.laravel.com $2 $3
    fi

    docker exec $IT -w /var/www/html autopilot composer install --no-dev
    docker exec $IT -w /var/www/html autopilot php artisan key:generate
    docker exec $IT -w /var/www/html autopilot php artisan migrate --seed

    echo "DONE!"
    ;;
'update')  echo "Updating Autopilot"
    docker pull sitepilot/autopilot:latest

    docker-compose -f $BASE/docker-compose.yml --env-file $BASE/.env up -d

    echo "Waiting for containers..."
    sleep 10

    docker exec $IT -w /var/www/html autopilot composer install --no-dev
    docker exec $IT -w /var/www/html autopilot php artisan migrate --seed

    echo "DONE!"
    ;;
'exec')
    docker exec $IT -w /var/www/html autopilot "${@:2}"
    ;;
*)
    docker exec $IT -w /var/www/html autopilot php artisan $@
    ;;
esac
