---
- name: Download OpenLitespeed repository script.
  get_url:
    url: http://rpms.litespeedtech.com/debian/enable_lst_debain_repo.sh
    dest: /opt/sitepilot/scripts/olsws-repo-install.sh
    mode: "0700"
    force: yes

- name: "Install OpenLitespeed repository."
  shell: /opt/sitepilot/scripts/olsws-repo-install.sh

- name: Install OpenLitespeed web server and PHP packages.
  apt:
    name: >
      openlitespeed,
      lsphp74,
      lsphp74-common,
      lsphp74-json,
      lsphp74-mysql,
      lsphp74-opcache,
      lsphp74-igbinary,
      lsphp74-memcached,
      lsphp74-redis,
      lsphp74-imap,
      lsphp74-curl
    state: present
  notify:
    - reload olsws

- name: Enable OpenLitespeed on startup.
  service:
    name: lsws
    enabled: true

- name: "Create OpenLitespeed service folders."
  file:
    path: "{{ item.path }}"
    owner: "{{ admin }}"
    group: "{{ admin }}"
    state: directory
    recurse: "{{ item.recurse }}"
  loop:
    # OpenLitespeed
    - path: /tmp/lshttpd
      recurse: true
    - path: /opt/sitepilot/services/olsws
      recurse: false
    - path: /opt/sitepilot/services/olsws/tmp
      recurse: false
    - path: /opt/sitepilot/services/olsws/logs
      recurse: false

    # Default Vhost
    - path: /opt/sitepilot/services/default
      recurse: false
    - path: /opt/sitepilot/services/default/public
      recurse: false
    - path: /opt/sitepilot/services/default/logs
      recurse: false

- name: "Generate default vhost index page."
  template:
    src: index.php.j2
    dest: /opt/sitepilot/services/default/public/index.php
  when: autopilot_path is undefined

- name: Write default vhost configuration.
  template:
    src: vhost_default.conf.j2
    dest: /usr/local/lsws/conf/vhosts/default.conf
  notify:
    - reload olsws
  when: autopilot_path is undefined

- name: Write Autopilot vhost configuration.
  template:
    src: vhost_autopilot.conf.j2
    dest: /usr/local/lsws/conf/vhosts/autopilot.conf
  notify:
    - reload olsws
  when: autopilot_path is defined

- name: Generate an OpenSSL private key.
  openssl_privatekey:
    path: /usr/local/lsws/conf/cert/server.key

- name: Generate an OpenSSL csr.
  openssl_csr:
    path: /usr/local/lsws/conf/cert/server.csr
    privatekey_path: /usr/local/lsws/conf/cert/server.key
    common_name: "{{ hostname }}"

- name: Generate a self signed OpenSSL certificate.
  openssl_certificate:
    path: /usr/local/lsws/conf/cert/server.crt
    privatekey_path: /usr/local/lsws/conf/cert/server.key
    csr_path: /usr/local/lsws/conf/cert/server.csr
    provider: selfsigned

- name: "Add olsws admin password script."
  template:
    src: olsws-pass.sh.j2
    dest: /opt/sitepilot/scripts/olsws-pass.sh
    mode: "a+x"

- name: "Set olsws admin password."
  command: "/opt/sitepilot/scripts/olsws-pass.sh {{ admin }} {{ admin_pass }}"
  changed_when: false

- name: Rewrite olsws httpd config.
  template:
    src: httpd_config.conf.j2
    dest: /usr/local/lsws/conf/httpd_config.conf
    owner: lsadm
    group: lsadm
  notify: reload olsws

- name: Rewrite olsws admin config.
  template:
    src: admin_config.conf.j2
    dest: /usr/local/lsws/admin/conf/admin_config.conf
    owner: lsadm
    group: lsadm
  notify: reload olsws

- name: Rewrite olsws lsphp74 vhost template.
  template:
    src: lsphp74_template.conf.j2
    dest: /usr/local/lsws/conf/templates/lsphp74.conf
    owner: lsadm
    group: lsadm
  notify: reload olsws

- name: Generate olsws reload script.
  template:
    src: "olsws-reload.sh.j2"
    dest: "/opt/sitepilot/scripts/olsws-reload.sh"
    owner: "root"
    group: "root"
    mode: 0700

- name: Configure olsws reload cron.
  cron:
    name: "reload lshttpd"
    minute: "*"
    job: "/opt/sitepilot/scripts/olsws-reload.sh > /dev/null"
